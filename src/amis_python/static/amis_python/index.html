<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>AMIS Python Demo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <!-- 引入 AMIS SDK CSS -->
    <link rel="stylesheet" href="https://unpkg.com/amis@latest/sdk/sdk.css" />
    <!-- 引入 AMIS SDK JS -->
    <script src="https://unpkg.com/amis@latest/sdk/sdk.js"></script>
    <!-- 引入 history 库 -->
    <script src="https://unpkg.com/history@4.10.1/umd/history.js"></script>
    <style>
      html,
      body,
      .app-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="root" class="app-wrapper"></div>
    <script type="text/javascript">
      (function () {
        let amis = amisRequire('amis/embed');
        const match = amisRequire('path-to-regexp').match;
        
        // 使用 hash 历史记录
        const history = History.createHashHistory();
        
        // 从 API 获取 AMIS 配置
        fetch('/amis/config/')
          .then(response => response.json())
          .then(amisJSON => {
            
            // 定义 normalizeLink 函数，用来处理链接
            function normalizeLink(to, location = history.location) {
              to = to || '';
              
              if (to && to[0] === '#') {
                to = location.pathname + location.search + to;
              } else if (to && to[0] === '?') {
                to = location.pathname + to;
              }
              
              const idx = to.indexOf('?');
              const idx2 = to.indexOf('#');
              let pathname = ~idx
                ? to.substring(0, idx)
                : ~idx2
                ? to.substring(0, idx2)
                : to;
              let search = ~idx ? to.substring(idx, ~idx2 ? idx2 : undefined) : '';
              let hash = ~idx2 ? to.substring(idx2) : location.hash;
              
              if (!pathname) {
                pathname = location.pathname;
              } else if (pathname[0] != '/' && !/^https?\:\/\//.test(pathname)) {
                let relativeBase = location.pathname;
                const paths = relativeBase.split('/');
                paths.pop();
                let m;
                while ((m = /^\.\.?\//.exec(pathname))) {
                  if (m[0] === '../') {
                    paths.pop();
                  }
                  pathname = pathname.substring(m[0].length);
                }
                pathname = paths.concat(pathname).join('/');
              }
              
              return pathname + search + hash;
            }
            
            // 定义 isCurrentUrl 函数，用来判断当前 URL 是否与目标 URL 匹配
            function isCurrentUrl(to, ctx) {
              if (!to) {
                return false;
              }
              const pathname = history.location.pathname;
              const link = normalizeLink(to, {
                ...location,
                pathname,
                hash: ''
              });
              
              if (!~link.indexOf('http') && ~link.indexOf(':')) {
                let strict = ctx && ctx.strict;
                return match(link, {
                  decode: decodeURIComponent,
                  strict: typeof strict !== 'undefined' ? strict : true
                })(pathname);
              }
              
              return decodeURI(pathname) === link;
            }
            
            // 渲染 AMIS 应用
            let amisInstance = amis.embed(
              '#root',
              amisJSON,
              {
                location: history.location,
                data: {},
                context: {}
              },
              {
                // 主题配置
                theme: 'default',
                
                // 自定义 updateLocation 方法
                updateLocation: (location, replace) => {
                  location = normalizeLink(location);
                  if (location === 'goBack') {
                    return history.goBack();
                  } else if (
                    (!/^https?\:\/\//.test(location) &&
                      location ===
                        history.location.pathname + history.location.search) ||
                    location === history.location.href
                  ) {
                    // 目标地址和当前地址一样，不处理，免得重复刷新
                    return;
                  } else if (/^https?\:\/\//.test(location) || !history) {
                    return (window.location.href = location);
                  }
                  
                  history[replace ? 'replace' : 'push'](location);
                },
                
                // 自定义 jumpTo 方法
                jumpTo: (to, action) => {
                  if (to === 'goBack') {
                    return history.goBack();
                  }
                  
                  to = normalizeLink(to);
                  
                  if (isCurrentUrl(to)) {
                    return;
                  }
                  
                  if (action && action.actionType === 'url') {
                    action.blank === false
                      ? (window.location.href = to)
                      : window.open(to, '_blank');
                    return;
                  } else if (action && action.blank) {
                    window.open(to, '_blank');
                    return;
                  }
                  
                  if (/^https?:\/\//.test(to)) {
                    window.location.href = to;
                  } else if (
                    (!/^https?\:\/\//.test(to) &&
                      to === history.pathname + history.location.search) ||
                    to === history.location.href
                  ) {
                    // do nothing
                  } else {
                    history.push(to);
                  }
                },
                
                // 自定义 isCurrentUrl 方法
                isCurrentUrl: isCurrentUrl
              }
            );
            
            // 监听历史记录变化，更新 AMIS 实例的 props
            history.listen(state => {
              amisInstance.updateProps({
                location: state.location || state
              });
            });
          })
          .catch(error => {
            console.error('Failed to load AMIS config:', error);
            document.getElementById('root').innerHTML = '<div style="padding: 20px; color: red;">加载配置失败，请检查网络连接或服务器状态</div>';
          });
      })();
    </script>
  </body>
</html>